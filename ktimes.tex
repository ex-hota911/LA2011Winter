\section{任意回微分可能関数と常微分方程式}

 第二変数について任意回微分可能な関数の常微分方程式の解は, 
 \DIVPlog 困難でありうることを証明する.


\subsection{対数深さ離散初期値問題を模倣する関数族}

 証明の流れは $(\infty, 1)$ 階連続的微分可能の時と変わらない.
 任意の言語 $L \in $ \DIVPlog, 文字列 $u$ にたいして,
 上記の対数深さ離散初期値問題を模倣し $L(u)$ を計算する
 任意回微分可能な実関数 $g_u$ を構成する.

 \begin{lemma}
  \label{KTimesFamily}
  任意の自然数 $k \ge 2$,
  任意の言語 $L \in \DIVPlog$ にたいして,
  係数のみに $i$ を含む多項式 $\mu_i$ が存在して,
  任意の多項式 $\gamma$ にたいして,
  関数 $\rho \colon \N \to \N$, 関数族 $g_u, h_u$ で,
  $\rho, (g_u)_u$ は多項式時間計算可能であり,
  各二進文字列 $u$ にたいして以下を満たすものが存在する.
  \begin{enumerate}
   \item $g_u\colon [0,1] \times [-1,1]\to \R, \quad h_u\colon [0,1] \to [-1,1]$;
   \item $h_u$ は $g_u$ の常微分方程式 (\ref{eq:ode}) の解;
   \item $g_u$ は $(\infty, k)$ 階連続微分可能;
   \item 任意の $i \in \N$, $y \in [-1,1]$ にたいして
	 \begin{equation*}
	  \D{i, 0} g_u(0,y) = \D{i, 0} g_u(1,y) = 0 
	 \end{equation*}
   \item 任意の $i \in \N$, $j \in \{0, \dots, k\}$ にたいして
	 \begin{equation*}
	  \left|\D{i,j} g_u(t,y)\right| \le 2^{\mu_i(|u|) - \gamma(|u|)}
	 \end{equation*}
   \item $h_u(1) = 2^{-\rho(|u|)}L(u)$.
  \end{enumerate}
 \end{lemma}

 \begin{proof}
  $L \in \DIVPlog$ を認識する
  対数深さ離散初期値問題 $\left< d, p, q,(G_u)_u \right>$
  とその解 $(H_u)_u$ を得る. さらに以下のように仮定する.
  \begin{equation}
   H_u(i, 2^{q(|u|)}) = \begin{cases}
			L(u) & (i=p(|u|)) \\
			0 & (i<p(|u|)).
			\end{cases}
  \end{equation}

  補題 \ref{SmoothFunction} の $f$ にたいして, 
  自然数の族 $c_i$ を各 $i \in \N$ にたいして 
  $|\D{i}f(x)| \le 2^{c_i}$ を満たす最小の自然数と定める.
 定数 $d' = \lceil \log (4d + 1) \rceil$, 
 $B = 2^{\poly \gamma + d'}$ とおき, 
 各 $(t, y) \in [0,1] \times [-1, 1]$ にたいして,
 自然数 $N$, $\theta \in [0,1]$, 整数 $Y$, $\eta \in [-1/4, 3/4]$ を
 $t = (T + \theta)2^{-q(|u|)}$, $y = (Y + \eta)B^{-k^{j_u(T)}}$ を満たすように
 定める.
 
 そのとき,
 \begin{equation}
  \delta_{u, Y} (t) = \frac{2^{q(|u|)} f'(\theta)}{B^{k^{j_u(T)+1}}} 
   G_u\left( j_u(T), T, \min \left(Y \bmod 2^{d'}\!\!\!,\ d-1 \right) \right)
 \end{equation}
 とおき $g_u, h_u$ を以下のように定義する.
 \begin{equation}
  g_u(t,y) 
  = \begin{cases}
     \delta_{u, Y}(t)
     & (\eta \le \frac 1 4)
     \\
     ( 1-f ( \frac{4\eta-1}{2})) \delta_{u, Y}(t) 
     + f ( \frac{4\eta-1}{2}) \delta_{u,Y+1}(t)
     & (\eta > \frac 1 4)
    \end{cases}
 \end{equation}

 \begin{equation} 
  h_u(t) = \sum^{p(|u|)}_{i=0} \frac{H_u(i, T)}{B^{k^i}}  
  + \frac{f(\theta)}{B^{k^{j_u(T)+1}}} G_u(j_u(T), T, H_u(j_u(T), T)) 
  \label{eq:hu}
 \end{equation}

 上記のように定義した $g_u, h_u$ が補題\ref{DifferentiableFamily} で求める
 性質を満たすことを示す. (i) は自明. 
 $(g_u)_u$ が多項式時間計算可能であることは
  補題 \ref{lem:type1representation}によって示される.

 $h_u$ は $g_u$ の常微分方程式の解であることを示す.
 まず $h_u$ について解析する. 
  $h_u(t) = (Y + \eta) B^{-k^{j_u(T)}}$ とおくときの, $\eta$ の範囲がどうなるか,
  つまり式(\ref{eq:gu})のどちらのケースを使うかを考える.
  式(\ref{eq:hu}) の一つ目の項において
 $i \le j_u(T)$ の合計は $B^{k^{j_u(T)}}$ の倍数なので $\eta$ に影響はない.
  $i > j_u(T)$ の合計は, 
 \begin{align*}
  \sum_{i>j_u(T)}^{p(|u|)} \frac{H_u(i, T)}{B^{k^i}} 
  & \le \sum_{i>j_u(T)}^\infty \frac{d-1}{B^{k^i}}  \\
  & \le \sum_{i>j_u(T)}^\infty \frac{d-1}{B^i} 
   = \sum_{i>j_u(T)}^\infty \frac{d-1}{B^{i-j_u(T)}}B^{-j_u(T)} \\
  & \le \sum_{i>j_u(T)}^\infty \frac{d-1}{(4d+1)^{i-j_u(T)}}B^{-j_u(T)} \\
  & = \frac{d-1}{4d}B^{-j_u(T)}
 \end{align*}
 二つ目の項の絶対値は
 \begin{equation}
  \left| \frac{f(\theta)}{B^{k^{j_u(T)+1}}} G_u(j_u(T), T, H_u(j_u(T), T)) \right|
  \le \frac{1}{B^{j_u(T)+1}}
  \le \frac{B^{-j_u(T)}}{4d+1}
 \end{equation}
 $(\frac{d-1}{4d} + \frac{1}{4d+1})B^{-j_u(T)} \le \frac 1 4 B^{-j_u(T)} $
  より $h_u(t) = (Y + \eta) B^{-j_u(T)}$ を満たす $\eta \in [-1/4, 1/4]$
 が存在する. このとき,
 \begin{equation}
  Y = \sum_{i=0}^{j_u(T)}H_u(i, T) \cdot B^{k^{j_u(T)} - k^i} .
 \end{equation}
 $B$ は $2^{d'}$ の倍数なので, 
 $\min (Y \bmod 2^{d'}\!\!\!,\ d-1) = \min (H_u(j_u), d-1) = H_u(j_u)$. 
 $g_u$ に代入すると,
 \begin{align*}
   g_u(t, h_u(t)) 
  & =  \frac{2^{q(|u|)} f'(\theta)}{B^{k^{j_u(T)+1}}}
   G_u(j_u(T), T, H_u(j_u(T), T)) \\
  & =  \D{1}h_u(t).
 \end{align*}
 よって $h_u$ は $g_u$ の常微分方程式の解.

  $g_u$ が $(\infty, k)$ 階連続的微分可能であることを証明する.
  $\eta$ が $[-1/4, 1/4]$ と $[1/4, 3/4]$ である区間それぞれにおいて微分する.
  任意の $i \in \N$ について

  \begin{equation}
   \D{i}\delta_{u,Y}(t) 
    = \frac{2^{(i+1)q(|u|)} \D{i+1}f(\theta)}{B^{k^{j_u(T)+1}}}
    G_u\left( j_u(T), T, \min \left(Y \bmod 2^{d'}\!\!\!,\ d-1 \right) \right)
  \end{equation}

  \begin{equation}
   \label{eq:derivativeofgu}
    \D{i,0} g_u(t, y)
     = \begin{cases}
 	\D{i} \delta_{u, Y}(\theta) 
	\hfill (- \frac 1 4 < \eta < \frac 1 4) \\
	\left( 1-f \left(\frac{4\eta-1}{2}\right)\right) 
	\D{i} \delta_{u, Y}(\theta) 
	+ f \left(\frac{4\eta-1}{2}\right) \D{i} \delta_{u,Y+1}(\theta) \\
	\hfill (\frac 1 4 < \eta < \frac 3 4)
       \end{cases}
  \end{equation}   
  $j \in \{1, \dots , k\}$ について,

  \begin{equation}
    \D{i,j} g_u(t, y)
     = \begin{cases}
	0 \hfill (- \frac 1 4 < \eta < \frac 1 4) \\
	(2B^{j_u(T)})^j \D{j}f(\frac{4\eta - 1}2)
	(\D{i}\delta_{u,Y+1}(\theta)-\D{i}\delta_{u, Y}(\theta)) \\
	\hfill (\frac 1 4 < \eta < \frac 3 4)
       \end{cases}
  \end{equation}
  $f$ は 無限回微分可能であるため, $\delta_{u,Y}$ も無限回微分可能である.
  よって 区間 $(-1/4, 1/4)$, $(1/4, 3/4)$ において
  $\D{i, 0} g_u$, $\D{i,j} g_u$ は連続. 
  $\eta = 1/4$ および  $\eta = 3/4(-1/4)$ においても連続であることは自明.
  $\D{i+1, 0} f(0) = \D{i+1, 0} f(1) = 0$ より $\theta = 0$ または $\theta = 1$
  において $\D{i, 0}g_u(t, y) = 0$, $\D{i, j}g_u(t, y) = 0$,
  よって $t$ についても連続.
  以上により $g_u$ は $(\infty, j)$ 階連続的微分可能であることがしめされた.

  式 (\ref{eq:derivativeofgu}) に $t = 0, 1$ ($\theta = 0$) を代入して
  $\D{i, 0} g_u(0,y) = \D{i, 0} g_u(1,y) = 0$.

  任意の $i \in \N$, $j \in \{0, \dots, k\}$ について
  $|\D{i,j} g_u| \leq 2^{\mu_i (|u|) - \gamma(|u|)}$ を示す.

  \begin{equation}
   |\D{i}\delta_{u, Y}(t)| 
    \le \left|\frac{2^{(i+1)q(|u|)}\D{i+1}f(\theta)}{B^{k^{j_u(T)+1}}} \right|
    \le \frac{2^{(i+1)q(|u|) + c_i}}{B^{k^{j_u(T)+1}}}\\
  \end{equation}

  $\mu_i(k) = (i+1)q(k) + \sum^k_{j=1}c_i + c_i + k + 1$ とおく.
  これは $\lambda$ に依存しない.
  $B$ の定義より

  \begin{align*}
   \left| \D{i,0} g_u \right| 
   &\le 
   |\D{i}\delta_{u, Y}(t)| 
    \le \frac{2^{(i+1)q(|u|) + c_i}}{B} 
    \le 2^{\mu_i (|u|) - \gamma(|u|)}
   \taghere 
   \\
   \left| \D{i,j} g_u \right| 
   & \le 
   (2B^{j_u(T)})^j \left|\D{j}f\left(\frac{4\eta - 1}2\right)\right|
   \cdot \left|\D{i}\delta_{u,Y+1}(t)-\D{i}\delta_{u, Y}(t)\right| \\
   & \le
   2^k B^{k \cdot j_u(T)} \cdot 2^{c_j} \cdot 
   2 \cdot \frac{2^{(i+1)q(|u|) + c_i}}{B^{k^{j_u(T)+1}}}\\
   & \le
   \frac{2^{(i+1)q(|u|) + \sum^k_{j=1}c_j + c_i +  k + 1}}{B}
   \le
   2^{\mu_i (|u|) - \gamma(|u|)} . \taghere
  \end{align*}

 (vii) は 
 \begin{align*}
  h_u(1) &= \frac{H_u(p(|u|), 2^{q(|u|)})}{B^{p(|u|)}}  \\
  &= \frac{L(u)}{2^{p(|u|) (\poly \gamma + d')}} \taghere
 \end{align*}
 より, $\rho(k) = p(k)(\gamma(k) + d')$ とおくと成り立つ.
 \end{proof}





\subsection{定理 \ref{KTimesIsPspace} の証明}

補題 \ref{DifferentiableFamily} とくらべて補題 \ref{KTimesFamily} は
\PSPACE が \DIVPlog に置き換わり,
$(\infty, 1)$ 回連続微分可能が $(\infty, k)$回連続微分可能に一般化されている
こと以外は変わらない. この関係は定理 \ref{DifferentiableIsPspace} と定理
\ref{KTimesIsPspace} との間の関係と等しい.
よって証明も \PSPACE を \DIVPlog で置き換え,
$(\infty, 1)$ 回連続微分可能を $(\infty, k)$回連続微分可能に一般化させることで,
定理 \ref{DifferentiableIsPspace} の証明から定理 \ref{KTimesIsPspace} の証明が
構成できる.
\footnote{なのでこの章まるまる必要ない.しかしこちらの証明のほうが1回微分可能のときの
証明より一般化されているため, どちらを採用するか要検討}


\begin{proof}
 $L$ を \DIVPlog に含まれる言語,
 つまり対数深さ離散初期値問題によって認識される言語とおく.
 $L$ にたいして補題 \ref{DifferentiableFamily} を用いて,
 まず多項式 $\mu_i$ をえる.
 $\mu_i$ は $i$ を係数部にのみ持つ多項式であるため,
 $\mu_i(k) = O(k^c)$ をみたす最小の定数 $c$ が存在する.
 \begin{align}
  \lambda(k) &= 2k + 2,&
  \gamma(k) &= k^{c+1} + k \lambda(k)
 \end{align}
 とおき, 各 $u$ にたいして 
\begin{align}
 \Lambda_u 
 &= 2^{\lambda(|u|)}, &
 c_u 
 &= 1-\frac{1}{2^{|u|}}+\frac{2\bar{u}+1}{\Lambda_u}, &
 l_u^\mp 
 &= c_u\mp\frac{1}{\varLambda_u} 
\end{align}  
 とおく. ただし $\bar u \in \{0, \dots, 2^{|u|} - 1\}$ は $u$ を二進数と
 して解釈した数.
 $\gamma$ にたいして, 再び補題より $\rho$, $(g_u)_u$, $(h_u)_u$ を得る.



 任意の $[0,1)$ の実数にたいして,
 $l^\mp_u \pm \frac{t}{\Lambda_u}$ がその実数と等しくなるような
 $u, \pm, t\in [0,1]$ が存在する.
 関数 $g, h$ を $t \in [0,1]$, $y \in \R$ にたいして,
 それぞれ $[0,1) \times [-1,1]$ の範囲と $[0,1)$ の範囲で下のように定義する.



 \begin{align}
 g \left(l^\mp_u \pm \frac{t}{\Lambda_u}, \frac{y}{\Lambda_u}\right)
  &= \begin{cases}
      \pm \displaystyle \sum_{l=0}^k \frac{\D{0,l}g_u(t,1)}{l!} (y-1)^l 
      &  (1<y) \\
      \pm g_u(t, y)      & (-1 \le y \le 1) \\
      \pm \displaystyle \sum_{l=0}^k \frac{\D{0,l}g_u(t,-1)}{l!} (y+1)^l  
      &  (1<y) \\
    \end{cases} 
  \\
 h \left( l^\mp_u \pm \frac{t}{\Lambda_u} \right) 
  & = \frac{h_u(t)}{\Lambda_u}.
\end{align}
 任意の $y \in \R$ にたいして $g(1,y) = h(1) = 0$ と定義する.




 この $g$ と $h$ が定理 \ref{KTimesIsPspace} で求める関数
 の性質を満たすことを示す.



 
 まず $g$ が多項式時間計算可能であることを
 補題 \ref{lem:type1representation} を用いて示す.
 各有理数 $T,Y$ について $g(T, Y)$ を求めるとき,
 $T=l_u^\mp \pm t/\Lambda_u$, $Y = y/\Lambda_u\Gamma_u$ を満たすような
 $u, \pm, t, y$ は, 多項式時間で計算可能であり,
 $(g_u)_u$ は多項式時間計算可能なので $g(T, Y)$ は多項式時間計算可能.




 $g$ が $(\infty, k)$ 階連続的微分可能であることをしめす.
 
 $g_u$ は $(\infty, k)$ 階連続的微分可能であるため,
 各区間においては $(\infty, k)$ 階連続的微分可能である.
 $t \in (0, 1)$ において

 \begin{multline}
  \D{i, j}g \left(l^\mp_u \pm \frac{t}{\Lambda_u}, \frac{y}{\Lambda_u}\right)
  \\
   = \begin{cases}
      \pm \Lambda_u^{i+j} \sum_{l=j}^k \frac{\D{i,l}g_u(t, 1)}{(l-j)!}
      (y-1)^{l-j}
      &  (1<y)\\
      \pm \Lambda_u^{i+j} \D{i,j}g_u(t, y)
      (y-1)^{l-j}
      & (-1 < y < 1) \\
      \pm \Lambda_u^{i+j} \sum_{l=j}^k \frac{\D{i,l}g_u(t, -1)}{(l-j)!}
      (y+1)^{l-j}
      & (y<-1)
    \end{cases}
 \end{multline}

 $\D{i,j}g_u$ は連続であるため 
 $t \in (0,1)$, $y \not = -1, 1$ の区間において連続.
 確認すべきなのは $g_u$ 同士をつなぐ境界 $t = 0, 1$ と
 $g_u$ の外側との境界 $y = 0, 1$,  
 および極限 $g_u$ の極限, つまり $g$ の第一引数が 1 へ限りなく近づくとき
 発散せずに連続であることである.

 $y = 1$ のとき 
 $\D{i, j}g \left(l^\mp_u \pm t / \Lambda_u, y / \Lambda_u\right) = 
 \pm \Lambda_u^{i+j} \D{i, j} g_u(t, 1)$,
 $y = -1$ のとき 
 $\D{i, j}g \left(l^\mp_u \pm t / \Lambda_u, y / \Lambda_u\right) = 
 \pm \Lambda_u^{i+j} \D{i, j} g_u(t, -1)$
 より $\D{i,j}g$ は第二変数について連続である.

 第一変数が $[0,1)$ の範囲にあるとき,
 つまり $l^\mp_u \pm t/\Lambda_u$ と表される範囲において連続であることをしめす.
 $t = 1$ において $g_u$ と $-g_u$ が接続され,
 $t = 0$ において $g_u$ とつぎの文字 $u'$ の関数 $g_{u'}$ が接続されている.
 ここで $\D{i,0} g_u(0, y) = \D{i, 0} g_u(1, y) = 0$ より
 $\D{i,j} g_u(0, y) = \D{i,j} g_u(1, y) = 0$.
 よって  $\D{i,j} g(0, y) = \D{i,j} g(1, y) = 0$ なので $[0,1)$ で連続.

 最後に第一変数が $1$ へ向かうとき発散しないことをしめす.
 \begin{align*}
  \left|\D{i, j}g \left(l^\mp_u \pm \frac{t}{\Lambda_u},
  \frac{y}{\Lambda_u}\right)\right|
  & \le \Lambda_u^{i+j} \sum_{l=j}^k \frac{|\D{i,l}g_u|}{(l-j)!}
      (|y|+1)^{l-j} \\
  & \le \Lambda_u^{i+j} 2^{\mu_i(|u|) - \gamma(|u|)} \sum_{l=j}^k 
      (2\Lambda_u)^{l-j} \\
  & \le \Lambda_u^{i+j} 2^{\mu_i(|u|) - \gamma(|u|)}
      (2\Lambda_u)^{k-j+1} \\
  & = 2^{\mu_i(|u|) + (i + k + 1)\lambda(|u|) + k - j + 1 - \gamma(|u|)}
  \taghere
 \end{align*}
 $\gamma$ のとり方により, $|u| \to \infty$ のとき 0 に収束する.
 よって  $\lim_{t \to 1-0}\D{i,j} g(t,y) = 0$.
 とくに $i=0$ のとき, $\lim_{t \to 1-0} g(t,y) = 0 = g(1, y)$ より 1 で連続.
 以上により $g$ が $(\infty, k)$ 階連続的微分可能であることをしめした.




 $h$が$g$の常微分方程式の解であることを示す. 
 $h(0)=0, \quad \D{1}h(1) = 0 = g(1,h(1))$ は自明. 
 \begin{align*}
  h' \left( l^\mp_u \pm \frac{t}{\Lambda_u} \right)
  &= \pm \frac{h'_u(t)}{\Lambda_u} \\ 
  &= \pm g_u \left(t, h_u(t)\right) \\
  &= g\left(l^\mp_u \pm \frac{t}{\Lambda_u},  
	\frac{h_u(t)}{\Lambda_u}\right) \\ 
  &= g\left(l^\mp_u \pm \frac{t}{\Lambda_u}, 
	h\left(l^\mp_u \pm \frac{t}{\Lambda_u}\right) \right) . \taghere
 \end{align*}



 $L$ は $h$ に還元可能であることを示す.
 \begin{equation}
  h(c_u) = \frac{h_u(1)}{\Lambda_u}
   = \frac{L(u)}{2^{\lambda(|u|)+\rho(|u|)}}
 \end{equation}
 つまり $R,S,T$ を以下のように定義することで, 還元可能.
 \begin{align}
  R(u,v) &= v \\
  S(u, 0^n) &= \lfloor 2^nc_u \rfloor \text{を表す文字列,} \\
  T(u) &= 0^{\lambda(|u|)+\rho(|u|)}
 \end{align}
 任意の $L \in \DIVPlog$ について $h$ へ還元可能であるため, $h$ は \DIVPlog 困難.
\end{proof}
