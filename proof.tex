\section{証明}
\label{section:differentiable}

本節では次の手順で定理\ref{DifferentiableIsPspace}, \ref{KTimesIsCH}を示す. 
まずある種の差分方程式の族が, 
$\classPSPACE$困難ないし$\classCH$困難であることを示す
(\ref{section:divp}節, \ref{subsection: counting hierarchy}節).
そしてこの差分方程式が, 
滑らかさの条件を満たす\eqref{eq:ode}の形の微分方程式の族により模倣されることを示す
(\ref{subsection: ode family}節). 
この族を一つの滑らかな微分方程式へ埋め込むことで, 
定理にいう$g$, $h$を構成する(\ref{subsection: proof of theorems}節).

このように微分方程式で差分方程式を模倣する考え方は, 
既にLipschitz条件の場合の証明
\cite{kawamura2010lipschitz}にも本質的には現れていたものであるが, 
本稿ではより精密に, 滑らかさの条件が与える影響を調べるため, 
差分方程式の構造に着目する. 
その結果, 
$2$回以上連続微分可能という制限の下でも, 
差分方程式族の「深さ」が小さければ模倣できることが判り, 
そのことから$\classCH$困難性が従う. 

\subsection{差分方程式}
\label{section:divp}

この節では微分方程式\eqref{eq:ode}の離散版ともいうべき差分方程式を定義し, 
それが深さの制限に応じて
$\classPSPACE$困難ないし$\classCH$困難であることを示す.

$[n] = \{0, \dots , n-1\}$と書く.
関数$G \colon [P] \times [Q] \times [R] \to \{-1, 0, 1\}$と
$H \colon [P + 1] \times [Q+1] \to [R]$が
任意の$i \in [P]$, $T \in [Q]$について以下を満たすとき(図\ref{fig:divp}), 
\begin{figure}
 \begin{center}
  \includegraphics[height=0.15\textheight]{image/divp.eps}
 \end{center}
 \caption{差分方程式$G$とその解$H$}
 \label{fig:divp}
\end{figure}
$H$を\emph{差分方程式}\kern\xkanjiskip$G$の解と呼ぶ.
\begin{gather}
   H(i, 0) = H(0, T) = 0 \label{eq:initial value}
\\
   H(i + 1, T + 1) - H(i+1, T) = G(i, T, H(i, T))  \label{eq:divp}
\end{gather}
$P$, $Q$, $R$をそれぞれこの差分方程式の
\emph{段数}, \emph{列数}, \emph{欄の大きさ}と呼ぶ.
\eqref{eq:ode}の初期条件$h(0) = 0$と方程式$\D h(t) = g(t, h(t))$が
それぞれ式\eqref{eq:initial value}, \eqref{eq:divp}に似ており, 
\ref{subsection: ode family}節ではこれを用いて
微分方程式で差分方程式を模倣する. 


文字列$u$ごとに一つの差分方程式$G _u$を与え,
$u$が言語$L$に属するかをその差分方程式によって計算することを考える.
各 $u$ に対して $G_u$ の段数と列数, 解をそれぞれ $P_u, Q_u, H_u$ としたとき,
言語$L$が関数族$(G_u)_u$によって
\emph{認識}されるとは,
$H_u(P_u, Q_u) = L(u)$ を満たすこととする.

族$(G_u)_u$が\emph{一様}であるとは,
$G_u$の段数, 列数, 欄の大きさそれぞれを$u$を入力とする関数と見做したとき
それらが多項式時間計算可能であり,
かつ与えられた$(u, i, T, Y)$から多項式時間で$G_u(i, T, Y)$が
計算できることと定義する.
そのようなとき$G _u$の段数, 列数及び欄の大きさは,
$|u|$の多項式の指数($2^{\mathrm{poly} (|u|)}$)で抑えられる.
$G_u$の段数を$P_u$と置くとき, 多項式$p$が存在して$P_u \le p(|u|)$が成立つとき,
族 $(G_u) _u$は\emph{多項式段}であるという.
また定数$c,d$が存在して$P_u \le c \log(|u|)+d$が成立つとき,
族 $(G_u) _u$は\emph{対数段}であるという. 
この用語を使うと, 
河村がLipschitz連続な場合の解析に用いた補題
\cite[補題4.7]{kawamura2010lipschitz}は次のように書ける. 

\begin{lemma}
 \label{DIVPpolyIsPSPACEhard}
 多項式段の一様な差分方程式族によって認識される$\classPSPACE$困難な言語が存在する
 \footnote{差分方程式によって認識される言語のクラスはカープ帰着において閉じており,
多項式段一様な関数族によって認識される言語は$\classPSPACE$と一致する.}.
\end{lemma}

河村\cite{kawamura2010lipschitz}は
この多項式段の一様な差分方程式族をLipschitz連続な微分方程式で模倣することで, 
表\ref{table:related}第三行の結果を得た. 
本稿の定理\ref{DifferentiableIsPspace}はこの構成に手を加えて, 
$(\infty, 1)$回微分可能な模倣に
作り替えることにより
(\ref{subsection: ode family}, \ref{subsection: proof of theorems}節), 
やはり補題\ref{DIVPpolyIsPSPACEhard}から得られる. 

本稿では更に, 対象とする差分方程式族を対数段に制限すれば, 
$(\infty, 2)$回以上微分可能な関数によっても
模倣できることを示し
(\ref{subsection: ode family}, \ref{subsection: proof of theorems}節), 
これと次の補題から定理\ref{KTimesIsCH}を得る. 

\begin{lemma}
 \label{DIVPlogIsCHhard}
 対数段の一様な差分方程式族によって認識される$\classCH$困難な言語が存在する.
\end{lemma}

計数階層$\classCH$の定義と差分方程式の関係及び
補題\ref{DIVPlogIsCHhard}の証明は
\ref{subsection: counting hierarchy}節にて述べる.


\subsection{The Counting Hierarchy and Difference Equations of Logarithmic Height}
\label{subsection: counting hierarchy}

The polynomial hierarchy~$\classPH$ is defined using non-deterministic polynomial-time oracle Turing machines: 
\begin{align}
 \classSigma^p_0  &= \classP,
 &
 \classSigma^p_{n+1} &= \classNP ^{\classSigma^p_n},
 &
 \classPH &= \bigcup_n \classSigma^p_n.
\end{align}
In the same way, the counting hierarchy~$\classCH$
\cite{wagner1986complexity} 
is defined
using probabilistic polynomial-time oracle Turing machines%
\footnote{This characterization, introduced by Tor{\'a}n 
in \cite{toran1991complexity}, is different from Wagner's original one.
}: 
\begin{align} \label{eq:CH}
 \quantC_0 \classP  &= \classP,
 &
 \quantC_{n+1} \classP &= \classPP^{\quantC_n \classP},
 &
 \classCH &= \bigcup_n \quantC_n \classP.
\end{align}
It is known that $\classPH \subseteq \classCH \subseteq \classPSPACE$, 
but we do not know whether $\classPH = \classPSPACE$.


Each level of the counting hierarchy 
has a complete problem defined as follows.
For every formula $\phi(X)$ with the list $X$ of $l$ free propositional variables,
we write 
\begin{equation}
 \quantC^m X \phi(X) 
  \longleftrightarrow 
  \sum_{X \in \{0,1\}^l} \phi(X) \ge m,
\end{equation}
where $\phi(X)$ is identified with the function 
$\phi \colon \{0,1\}^l \to \{0,1\}$
such that $\phi(X) = 1$ if and only if $\phi(X)$ is true.
This ``counting quantifier'' $\quantC ^m$ generalizes 
the usual quantifiers $\exists$ and $\forall$, 
because $\quantC^1 = \exists$ and $\quantC^{2^l} = \forall$.
For lists $X _1$, ldots, $X _n$ of variables 
and a formula $\phi(X_1, \dots, X_n)$ with all free variables listed, 
we define
\begin{equation}
 \langle \phi(X_1, \dots, X_n), m_1, \dots, m_n \rangle \in \quantC_n B_{be}
 \longleftrightarrow
 \quantC^{m_1}{X_1} \cdots \quantC^{m_n}{X_n} \phi(X_1, \dots, X_n).
\end{equation}

\begin{lemma}[{\cite[Theorem 7]{wagner1986complexity}}] \label{lemma:CnP-complete}
 For every $n \ge 1$, 
 the problem $\quantC_n B_{be}$ is $\quantC_n\classP$-complete.
\end{lemma}

We define a problem $\quantC_{\log} B_{be}$ by
\begin{equation}
 \langle 0^{2^n}, u \rangle \in \quantC_{\log} B_{be}
 \longleftrightarrow
 u \in \quantC_n B_{be}.
\end{equation}
We show that $\quantC_{\log} B_{be}$ 
is $\classCH$-hard and recognized by a logarithmic-height uniform function family,
as required in Lemma~\ref{DIVPlogIsCHhard}. 

\begin{proof}[\textup{Proof of Lemma \ref{DIVPlogIsCHhard}}]
First we prove that $\quantC_{\log} B_{be}$ is $\classCH$-hard.
For each problem $A$ in $\classCH$, there is a constant $n$ such that $A \in \quantC_n \classP$.
From Lemma \ref{lemma:CnP-complete}, for each $u \in \{0,1\}^*$
there is a polynomial-time function $f_n$ such that
$u \in A \leftrightarrow f_n(u) \in \quantC_n B_{be}$. So
\begin{align}
 u \in A 
 & \longleftrightarrow \langle 0^{2^n}, f_n(u) \rangle \in \quantC_{\log} B_{be}.
\end{align}
Since $\langle 0^{2^n}, f_n(\cdot) \rangle$ is polynomial time computable,
$A$ is reducible to $\quantC_{\log} B_{be}$.


Next we construct a logarithmic-height uniform function family $(G_u)_u$
recognizing $\quantC_{\log} B_{be}$.
Let $u  = \langle 0^{2^n}, 
\langle \phi(X_1, \dots, X_n), m_1, \dots, m_n \rangle \rangle$, 
where $n$, $m_1, \dots, m_n$ are nonnegative integers 
and $\phi$ is a formula. 
(If $u$ is not of this form, then $u \notin \quantC_{\log} B_{be}$.)
 
We write $l_i = |X_i|$ and $s_i = i + \sum^i_{j=1}l_j$.
For each $i \in \{0, \dots, n\}$ and
$Y_{i+1} \in \{0,1\}^{l_{i+1}}, \dots, Y_n \in \{0,1\}^{l_n}$,
we write $\phi_i(Y_{i+1}, \dots, Y_n)$ for the truth value of the subformula
$\quantC^{m_{i}}{X_i} \cdots \quantC^{m_1}{X_1} \phi(X_1, \dots, X_i, Y_{i+1}, \dots, Y_n)$,
so that $\phi_0 = \phi$ and $\phi_n() = \quantC_{\log} B_{be} (u)$.
We regard the quantifier $\quantC^m$ as a function from $\N$ to $\{0,1\}$:
\begin{equation}
 C^m(x) 
  = \begin{cases}
     1 & \text{if} \ x \ge m, \\
     0 & \text{if} \ x < m.
    \end{cases}
\end{equation}
Thus,
\begin{equation} \label{eq:phi-step}
 \phi_{i+1}(Y_{i+2}, \dots, Y_n) 
  = C^{m_{i+1}}\left(\sum_{X_{i+1} \in \{ 0,1 \} ^{l_i}}
		\phi_i(X_{i+1}, Y_{i+2}, \dots, Y_{n})\right).
\end{equation}
For $T \in \N$, we write $T_i$ for the $i$th digit of $T$ written in binary,
and $T_{[i,j]}$ for the string $T_{j-1} T_{j-2} \cdots T_{i+1} T_{i}$.

For each $(i, T, Y) \in [n+1] \times [2^{s_n}+1] \times [2^{|u|}]$,
we define $G_u (i, T, Y)$ as follows.
The first row is given by
 \begin{equation}\label{eq:def-Gu:case0}
  G_u(0,T,Y) = 
   (-1)^{T_{s_1}}\phi(T_{[1,s_1]}, T_{[s_1+1,s_2]},
    \dots, T_{[s_{n-1}+1,s_n]}), 
 \end{equation}
and for $i \neq 0$, we define 
 \begin{equation} 
  G_u(i,T,Y) = 
   \begin{cases}
    (-1)^{T_{s_{i+1}}} C^{m_i}(Y) 
    & \text{if} \ T_{[1,s_i+1]} = 10 \cdots 0, \\
    0 & \text{otherwise}.
   \end{cases} 
 \end{equation}
Define $H_u$ from $G_u$ by \eqref{eq:initial value} and \eqref{eq:divp}.

We prove by induction on $i$ that $H_u(i, T) \in [2^{l_u}]$ for all $T$, and that
 \begin{equation} \label{eq:subformula}
  G_u(i,T,H_u(i,V)) = (-1)^{V_{s_{i+1}}} 
   \phi_i(V_{[s_i+1, s_{i+1}]}, \dots, V_{[s_{n-1}+1, s_n]})
 \end{equation}
for all $i \in [n+1]$ and $V \in [2^{s_n}+1]$
such that $V_{[1, s_i +1]} = 10 \cdots 0$.

For $i=0$, the claims follows from \eqref{eq:def-Gu:case0}.
For the induction step, assume \eqref{eq:subformula}. 
We have
 \begin{equation}
  H_u(i+1, T) 
  = \sum_{V = 0}^{T-1} G_u(i, V, H_u(i, V)) 
  = \sum_{V} (-1)^{V_{s_{i+1}}} \phi_i(V_{[s_i+1, s_{i+1}]}, 
   \dots, V_{[s_{n-1}+1, s_n]}). 
 \end{equation}
For $U \in \{0,1\}^*$, we write $\overline U$ for the number represented by $U$ as binary expression.
For $V < \overline{T_{[s_{i+1}+1, s_n]} 0 \cdots 0}$,
the number $V'$ which is equal to $V$ with flipping the $s_i+1$ digit is
also less than $\overline{T_{[s_{i+1}+1, s_n]} 0 \cdots 0}$,
and  $\phi_i(V_{[s_i+1, s_{i+1}]}, \dots, V_{[s_{n-1}+1, s_n]}) +
 - \phi_i(V_{[s_i+1, s_{i+1}]}, \dots, V_{[s_{n-1}+1, s_n]}) = 0$.
Since $T_{[1,s_{i+1} +1]} = 10 \cdots 0$,
 \begin{equation}
  H_u(i+1, T) = \sum_{X \in \{0,1\}^{l_i}}
  \phi_i(X, T_{[s_{i+1}+1, s_{i+2}]}, \dots, T_{[s_{n-1}+1, s_n]}).
 \end{equation}
 From this equation and \eqref{eq:phi-step}, it follows that
 \begin{align}
  G_u(i+1,T,H_u(i+1,T)) 
  &= (-1)^{T_{s_{i+2}}} C^{m_{i+1}} (H_u(i+1, T))
\notag
\\
  &= (-1)^{T_{s_{i+2}}} \phi_{i+1}(T_{[s_{i+1}+1, s_{i+2}]}, \dots, T_{[s_{n-1}+1, s_n]}).
 \end{align}


By substituting $n$ for $i$ and $2^{s_n}$ for $T$ in \eqref{eq:subformula},
we get $G_u(n, 2^{s_n}, H_u(n,2^{s_n})) = \phi_n() = \quantC_{\log} B_{be}(u)$.
Hence $H_u(n+1, 2^{s_n}+1) = \quantC_{\log} B_{be}(u)$.
 
The height $n+1$, the width $2^{s_n}+1$, and the cell size $2^{|u|}$
of $G_u$ are polynomial-time computable from $u$, 
and $n+1 \le \log(|0^{2^n}|) + 1 \le \log|u| + 1$.
Hence $(G_u)_u$ is uniform and has logarithmic height. 
\end{proof}


The language class recognized by uniform function families with $i$ rows
contains $\quantC_i \classP$ (the $i$th level of the counting hierarchy)
and is contained in $\quantC_{i+1} \classP$.
While the class $\quantC_i \classP$ is defined by \eqref{eq:CH} using oracle Turing machines,
it is also characterized as those languages Karp-reducible to $\quantC_i B_{be}$, or 
as those accepted by a polynomial-time alternating Turing machine 
extended with ``threshold states'' and having at most $i$ alternations.
Likewise, 
the language class accepted by uniform function families of logarithmic height
coincided with languages Karp-reducible to $\quantC_{\log} B_{be}$
and with those accepted by an extended alternating Turing machine with logarithmic alternations.
Since this class contains $\classCH$,
we only state $\classCH$-hard in Lemma \ref{KTimesFamily} and Theorem $\ref{KTimesIsCH}$,
but it is not known such class how hard the class is between $\classCH$ and $\classPSPACE$.



\subsection{Families of Real Functions Simulating Difference Equations}
\label{subsection: ode family}
We show that families of smooth differential equations can simulate 
$\classPSPACE$-hard or $\classCH$-hard difference equations stated in previous section.

Before stating Lemma \ref{KTimesFamily} and Lemma \ref{DifferentiableFamily},
we extend the definition of polynomial-time computability of real function
to families of real functions.
We say that a family $(f_u)_u$ of functions $f _u \colon A \to \R$ 
indexed by strings $u$ is computed by an oracle Turing machine $M$ 
if for any $x \in A$ and any name $\phi_x$ of $x$,
the function taking $v$ to $M ^{\phi _x} (u, v)$ is a name of $f _u (x)$.
We say a family of real functions $(f_u)_u$ is polynomial-time if there is
a polynomial-time machine computing $(f_u)_u$.

 \begin{lemma}
  \label{KTimesFamily}
  There exist a $\classCH$-hard language $L$ and a polynomial $\mu$ 
  such that for all $k \ge 1$ and polynomials $\gamma$,
  there are a polynomial $\rho$ and families $(g_u)_u$, $(h_u)_u$ of real functions
  having following properties that $(g_u)_u$ is polynomial-time computable and for any string $u$:
  \begin{enumerate}
   \item \label{enum:kf:start}
	 $g_u\colon [0,1] \times [-1,1]\to \R$, $h_u\colon [0,1] \to [-1,1]$;
   \item \label{enum:equation}
	 $h_u(0) = 0$ and $\D h_u(t) = g_u(t, h_u(t))$ for all $t \in [0,1]$;
   \item \label{enum:differentiability}
         $g_u$ is $(\infty, k)$-times continuously differentiable;
   \item \label{enum:boundary}
	 $
	 \D^{(i, 0)} g_u(0,y) = \D^{(i, 0)} g_u(1,y) = 0
         $ for all $i \in \N$ and $y \in [-1,1]$;
   \item \label{enum:smooth}
	 $
	 \left|\D^{(i,j)} g_u(t,y)\right| \le 2^{\mu(i, |u|) - \gamma(|u|)}
         $ for all $i \in \N$ and $j \in \{0, \dots, k\}$;
   \item \label{enum:kf:end}
	 $h_u(1) = 2^{-\rho(|u|)} L(u)$.
  \end{enumerate}
 \end{lemma}

\begin{lemma}
 \label{DifferentiableFamily}
 There exist a $\classPSPACE$-hard language $L$ and a polynomial $\mu$,
 such that for all polynomials $\gamma$,
 there are a polynomial $\rho$ and families $(g_u)_u$, $(h_u)_u$ of real functions
 such that $(g_u)_u$ is polynomial-time computable and for any string $u$
 satisfying (\ref{enum:kf:start})--(\ref{enum:kf:end}) of Lemma \ref{KTimesFamily} with $k = 1$.
\end{lemma}

We will prove Lemma~\ref{KTimesFamily} using Lemma~\ref{DIVPlogIsCHhard} as follows.
Let a function family $(G_u)_u$ be as in Lemma \ref{DIVPlogIsCHhard},
and let $(H_u)_u$ be the solution of the difference equation given by $(G_u)_u$.
For each $T = 0$, \ldots, $2^{q(|u|)}$,
we construct $h_u$ and $g_u$ from $H_u$ and $G_u$ 
such that $h_u(T/2^{q(|u|)}) = \sum^{p(|u|)}_{i = 0} H_u(i, T)/B^{d_u(i)}$ and $\D h_u(t) = g_u(t, h_u(t))$.
The polynomial-time computability of $(g_u)_u$ follows from that of $(G_u)_u$.
We will prove Lemma~\ref{DifferentiableFamily} from Lemma~\ref{DIVPpolyIsPSPACEhard} in the same way.

In Lemma \ref{KTimesFamily}, 
we have the new conditions (\ref{enum:differentiability})--(\ref{enum:smooth}) 
about the smoothness and the derivatives of $g_u$ 
that were not present in \cite[Lemma 4.1]{kawamura2010lipschitz}.
To satisfy these conditions, we construct $g_u$ 
using the smooth function $f$ in following lemma.

\begin{lemma}[{\cite[Lemma 3.6]{ko1991complexity}}]
 \label{SmoothFunction}
 There exist a polynomial-time infinitely differentiable function  $f \colon [0,1] \to \R$ 
 and a polynomial $s$ such that
  \begin{enumerate}
   \item $f(0) = 0$ and $f(1) = 1$;
   \item $\D ^n f (0) = \D ^n f (1) = 0$ for all $n \ge 1$;
   \item $f$ is strictly increasing;
   \item $\D ^n f$ is polynomial-time computable for all $n \ge 1$;
   \item \label{enum:polynomial-size}
	 $|\D^n f| \le s(n)$ for all $n \ge 1$. 
  \end{enumerate}
 \end{lemma}

Although the existence of the polynomial~$s$ satisfying the condition (\ref{enum:polynomial-size}) is not stated in \cite[Lemma 3.6]{ko1991complexity},
it can be shown easily.

We only prove Lemma \ref{KTimesFamily} here
and omit the analogous and easier proof of Lemma \ref{DifferentiableFamily}.

\begin{proof}[Proof of Lemma \ref{KTimesFamily}]
Let a function family $(G_u)_u$ be as in Lemma \ref{DIVPlogIsCHhard},
and let a function family $(H_u)_u$ be the solution of difference equation given by $(G_u)_u$.

By the same argument as at the beginning of the proof\cite[Lemma 4.1]{kawamura2010lipschitz},
we may assume that there exist polynomial-time functions $p$, $j_u$
and polynomial $q$, $r$ satisfying following properties:
\begin{gather}
 G_u \colon [p(|u|)] \times [2^{q(|u|)}] \times [2^{r(|u|)}] \to \{-1, 0, 1\};
 \\
 H_u(i, 2^{q(|u|)}) = \begin{cases}
		       L(u) & (i=p(|u|)) \\
		       0 & (i<p(|u|))
		      \end{cases};
 \\
 i \not = j_u(T)  \to G_u(i, T, Y) = 0.
\end{gather}
Since $G_u$ has logarithmic height,
there exists polynomial $\sigma$ such that $(k+1)^{p(x)} \le \sigma(x)$


We construct the families real functions $(g_u)_u$ and $(h_u)_u$ simulating $G _u$ and $H _u$.

  具体的には$h_u(T/2^{q(|u|)}) = \sum^{p(|u|)}_{i = 0}H_u(i, T)/B^{d_u(i)}$
  を満たすようにする. この$B$と関数$d_u \colon [p(|u|)+1] \to \N$を次で定める. 
  \begin{align}
   B &= 2^{\gamma(|u|) + r(|u|) + s(k) + k + 3}
   &
   d_u(i) &= 
   \begin{cases}
    \sigma(|u|) & (i=p(|u|)) 
    \\
    (k+1)^i & (i<p(|u|))
   \end{cases}
  \end{align}
各$(t, y) \in [0,1] \times [-1, 1]$に対して,
$t = (T + \theta)2^{-q(|u|)}$, $y = (Y + \eta)B^{-d_u(j_u(T))}$を満たす
$N \in \N$, 
$\theta \in [0,1)$, 
$Y \in \Z$, 
$\eta \in [-1/4, 3/4)$が
それぞれ唯一存在する.
関数$\delta_{u,Y} \colon [0,1] \to \R$を次で定める. 
 \begin{equation} \label{eq:delta}
  \delta_{u, Y} (t) = \frac{2^{q(|u|)} \D f(\theta)}{B^{d_u(j_u(T)+1)}} 
   G_u \bigl( j_u(T), T, Y \bmod 2^{r(|u|)} \bigr)
 \end{equation}
関数$
g _u \colon [0, 1] \times [-1, 1] \to \R
$と$
h _u \colon [0, 1] \to [-1, 1]
$を次で定義する.
ただし$f$と多項式$s$は補題\ref{SmoothFunction}のものである.
  \begin{align}
  \label{eq:gu}
  g_u(t,y) 
  &= \begin{cases}
     \delta_{u, Y}(t)
     & (\eta \le \frac 1 4)
     \\
     ( 1-f ( \frac{4\eta-1}{2})) \delta_{u, Y}(t)
     + f ( \frac{4\eta-1}{2}) \delta_{u,Y+1}(t)
     & (\eta > \frac 1 4)
    \end{cases}
   \\
  h_u(t) 
   &= \sum^{p(|u|)}_{i=0} \frac{H_u(i, T)}{B^{d_u(i)}}  
  + \frac{f(\theta)}{B^{d_u(j_u(T)+1)}} G_u \bigl( j_u(T), T, H_u(j_u(T), T) \bigr) 
  \label{eq:hu}
  \end{align}

この$g_u$, $h_u$が補題\ref{KTimesFamily}の各性質を満たすことを示す. 
性質(\ref{enum:equation})は
\cite[補題 4.1]{kawamura2010lipschitz}と同様に判る.

性質(\ref{enum:differentiability}), すなわち$g _u$が$(\infty, k)$回連続微分可能であることを示す.
  \eqref{eq:delta}, \eqref{eq:gu}より
  各$i \in \N$について
  \begin{align}
   \D^i \delta_{u,Y}(t) 
&
    = \frac{2^{(i+1)q(|u|)} \D^{i+1}f(\theta)}{B^{d_u(j_u(T)+1)}}
    G_u\left( j_u(T),\ T,\ Y \bmod 2^{r(|u|)} \right)
\\
   \label{eq:derivativeofgu}
    \D^{(i,0)} g_u(t, y)
&
     = \begin{cases}
 	\D^i \delta_{u, Y}(t) 
	& (- \frac 1 4 < \eta < \frac 1 4) \\
	\left( 1-f \left(\frac{4\eta-1}{2}\right)\right) 
	\D^i \delta_{u, Y}(t)
	+ f \left(\frac{4\eta-1}{2}\right) \D^i \delta_{u,Y+1}(t) 
	& (\frac 1 4 < \eta < \frac 3 4)
       \end{cases}
  \end{align}
  $j \in \{1, \dots , k\}$ について,
  \begin{equation}
    \D^{(i,j)} g_u(t, y)
     = \begin{cases}
	0 & (- \frac 1 4 < \eta < \frac 1 4) \\
	(2B^{d_u(j_u(T))})^j \D^j f(\frac{4\eta - 1}2)
	(\D^i \delta_{u,Y+1}(t)-\D^i \delta_{u, Y}(t)) 
	& (\frac 1 4 < \eta < \frac 3 4)
       \end{cases}
  \end{equation}
  境界においても連続であるため,
  $g _u$は$(\infty, j)$回連続微分可能であることが示された.
また式 (\ref{eq:derivativeofgu}) に $t = 0, 1$ ($\theta = 0$) を代入して
  $\D^{(i, 0)} g_u(0,y) = \D^{(i, 0)} g_u(1,y) = 0$.
  つまり(\ref{enum:boundary})が成立つ.

  (\ref{enum:smooth})を示す.
  $\mu(x, y) = (x+1)q(y) + s(x+1)$とおく.
  この$\mu$は$k$や$\gamma$に依存しない多項式である.
  式(\ref{eq:delta})より
  $|\D^i \delta_{u,Y}(t)| \le 2^{(i+1)q(|u|) + s(i+1)}B^{-d_u(j_u(|u|)+1)}$.
  任意の $i \in \N$, $j \in \{0, \dots, k\}$ について
  \begin{equation}
   |\D^{(i,j)} g_u| 
   \le 
   2^k B^{k \cdot j_u(T)} 2^{s(k)} \cdot 2 \cdot 
   \frac{2^{(i+1)q(|u|) + s(i+1)}}{B^{d_u(j_u(|u|)+1)}} 
   \le
   \frac{2^{\mu(i, |u|) + s(k) + k + 1}}{B}
  \end{equation}
  $B$のとり方により, $|\D^{(i,j)} g_u| \leq 2^{\mu(i, |u|) - \gamma(|u|)}$.

  (\ref{enum:kf:end})を示す.
  $\rho(x) = \sigma(x) \cdot (\gamma(x)+r(x)+s(k)+k+3)$ とおくと,
  \begin{equation}
   h_u(1) = \frac{H_u(p(|u|), 2^{q(|u|)})}{B^{d_u(p(|u|))}} 
          = \frac{L(u)}{2^{\sigma(|u|) \cdot (\gamma(|u|)+r(|u|)+s(k)+k+3)}}
	  = 2^{-\rho(|u|)} L(u).
  \end{equation}
 \end{proof}



 補題 \ref{DifferentiableFamily} の証明では$d_u$を$d_u(i) = i$と置き換え,
 $\classPSPACE$困難な言語を認識する多項式段一様関数族$(G_u)_u$とその解$(H_u)_u$に対して,
 式(\ref{eq:gu}), (\ref{eq:hu})により$(g_u)_u$と$(h_u)_u$を定義する.
 それらが補題 \ref{DifferentiableFamily} で求める性質を満たすことは,
 補題 \ref{KTimesFamily} の証明と同様に示される.


\subsection{主定理の証明}
\label{subsection: proof of theorems}

 証明の概略を示す.
 前の節の補題から得られる $(g_u)_u$ と $(h_u)_u$ を縮小して連結し滑らかな $g$ と
 解 $h$ を構成する.
 $[0,1)$ を無限個の区間$[l^-_u, l^+_u]$に分割し, 
 その中心を$c_u$としたとき, 各区間 $[l^-_u, c_u]$ に $h_u$ を縮小して埋め込む. 
 $h_u(1)$が後の計算に影響を与えないために,
 $h_u$ を定義域方向について反転したものを
 区間 $[c_u, l^+_u]$ に埋め込むことで相殺する.
 つまりある多項式$\rho'$に対して
 $h(l^-_u) = 0,\ h(c_u) = 2^{-\rho'(|u|)} L(u),\ h(l^+_u) = 0$ を満たす
 ように $h$ を構成する.
 また $g$ と $h$ が方程式(\ref{eq:ode})を満たすよう,
 各文字列 $u$ に対応する区間に $g_u$ を縮小して埋め込むことで $g$ を構成する.

 定理 \ref{DifferentiableIsPspace} は補題 \ref{DifferentiableFamily} を用いると,
 定理 \ref{KTimesIsCH} と同様に証明されるため, ここでは省略する.

\begin{proof}[定理 \ref{KTimesIsCH} の証明]
 $L$ を $\classCH$ 困難な言語とおく.
 $L$ に対して補題 \ref{DifferentiableFamily} を用いて,
 まず多項式 $\mu$ をえる.
 \begin{align}
  \lambda(x) &= 2x + 2,&
  \gamma(x) &= x \mu(x, x) + x \lambda(x)
 \end{align}
 とおき, 各 $u$ に対して 
\begin{align}
 \Lambda_u 
 &= 2^{\lambda(|u|)}, &
 c_u 
 &= 1-\frac{1}{2^{|u|}}+\frac{2\bar{u}+1}{\Lambda_u}, &
 l_u^\mp 
 &= c_u\mp\frac{1}{\Lambda_u} 
\end{align}  
 とおく. 
 %%% 補題3.4 の証明ででてきたためいらない？
 %ただし $\bar u \in \{0, \dots, 2^{|u|} - 1\}$ は $u$ を二進数として解釈した数.
 $\gamma$ に対して, 補題より $\rho$, $(g_u)_u$, $(h_u)_u$ を得る.


 任意の $[0,1)$ の実数は, 或る文字列 $u$, $\pm$, $t\in [0,1]$ を以って
 $l^\mp_u \pm \frac{t}{\Lambda_u}$ と書ける.
 関数 $g, h$ を $t \in [0,1)$, $y \in [-1, 1]$ に対して,
 \begin{align}
 g \left(l^\mp_u \pm \frac{t}{\Lambda_u}, \frac{y}{\Lambda_u}\right)
  &= \begin{cases}
      \pm \displaystyle \sum_{l=0}^k \frac{\D^{(0,l)}g_u(t,1)}{l!} (y-1)^l 
      &  (1<y) \\
      \pm g_u(t, y)      & (-1 \le y \le 1) \\
      \pm \displaystyle \sum_{l=0}^k \frac{\D^{(0,l)}g_u(t,-1)}{l!} (y+1)^l  
      &  (1<y) \\
    \end{cases} 
  \\
 h \left( l^\mp_u \pm \frac{t}{\Lambda_u} \right) 
  & = \frac{h_u(t)}{\Lambda_u}.
\end{align}
 $t=1$のとき $g(1,y) = 0$, $h(1) = 0$ と定義する.

 この $g$ が多項式時間計算可能であり$g$と$h$が方程式(\ref{eq:ode})を満たすことは,
 Lipschitz条件の場合と同様に示されるため,
 河村による証明を参照されたし\cite[定理3.2]{kawamura2010lipschitz}.
 ここでは特に$g$が$(\infty, k)$回連続微分可能であることのみ示す.

 $g_u$ は $(\infty, k)$ 回連続微分可能であるため,
 各区間においては$(\infty, k)$ 回連続微分可能である.
 $i \in \N$, $j \in \{0, \dots, k\}$, $t \in (0, 1)$ において
\begin{equation}
   \D^{(i, j)}g \left(l^\mp_u \pm \frac{t}{\Lambda_u}, \frac{y}{\Lambda_u}\right)
   = \begin{cases}
      \pm \Lambda_u^{(i, j)} \sum^{k}_{l=j} \frac{\D^{(i,l)} g_u(t,1)}{(l-j)!}
      (y - 1)^l &  (1<y)
      \\
      \pm \Lambda_u^{(i,j)} \D^{(i, j)} g_u(t, y) & (-1 < y < 1)
      \\
      \pm \Lambda_u^{(i, j)} \sum^{k}_{l=j} 
      \frac{\D^{(i,l)} g_u(t, -1)}{(l-j)!} (y + 1)^l &  (1<y)
    \end{cases}
\end{equation}
 $\D^{(i,j)}g_u$ は連続であるため 
 $t \in (0,1)$, $y \not = -1, 1$ において連続.
 境界($t = 0, 1$または$y = -1, 1$)において連続であることは,
 定義および補題 \ref{KTimesFamily} (\ref{enum:boundary})により示される.
 第一変数について $1$ の周辺で連続であることを示す.
 補題 \ref{KTimesFamily} の(\ref{enum:smooth})より
 \begin{align}
  \left|\D^{(i, j)}g \left(l^\mp_u \pm \frac{t}{\Lambda_u},
  \frac{y}{\Lambda_u}\right)\right|
  &\le 
  \Lambda_u^{i+j} \sum^{k}_{l=j} |\D^{(i,l)} g_u | (\Lambda_u + 1)^l 
  \notag
  \\
  & \le \Lambda_u^{i+j+k}  2^{k + \mu(i, |u|) - \gamma(|u|)}
   =  2^{(i+j+k)\lambda(|u|) + k + \mu(i, |u|)  - \gamma(|u|)}. 
  \label{eq:sizeofderivative}
 \end{align}
 $\gamma$ のとり方により, $|u| \to \infty$ のとき 
 式 (\ref{eq:sizeofderivative}) は$0$に収束する.
 よって  $\lim_{t \to 1-0}\D^{(i,j)} g(t,y) = g(1, y) = 0$.
 以上により$g$は$(\infty, k)$回連続微分可能.
\end{proof}


